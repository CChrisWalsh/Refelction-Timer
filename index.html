import React, { useState, useEffect, useRef } from "react";

const TOTAL_SECONDS = 5 * 60; // 5 minutes

const reflectionPrompts = [
  "Settle in. Take a deep breath and arrive in this moment.",
  "What is one idea from class content that feels most important?",
  "How does the content connect to your real work or life?",
  "What is one question you still have?",
  "What is one small action you will take after this class?",
  "Capture your final thought in a single sentence."
];

// Direct link to your calming music file in GitHub (raw content)
const SONG_URL =
  "https://raw.githubusercontent.com/CChrisWalsh/calmingmusic/main/reflective-silent-horizons-332367.mp3";

function formatTime(seconds: number) {
  const m = Math.floor(seconds / 60)
    .toString()
    .padStart(2, "0");
  const s = Math.floor(seconds % 60)
    .toString()
    .padStart(2, "0");
  return `${m}:${s}`;
}

function playChime() {
  try {
    const AudioContext =
      // @ts-ignore
      window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    oscillator.type = "sine";
    oscillator.frequency.setValueAtTime(1046.5, audioCtx.currentTime); // C6 bell-like

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    gainNode.gain.setValueAtTime(0.001, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(
      0.4,
      audioCtx.currentTime + 0.05
    );
    gainNode.gain.exponentialRampToValueAtTime(
      0.001,
      audioCtx.currentTime + 2.2
    );

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 2.4);
  } catch (e) {
    console.warn("Audio not supported in this environment.");
  }
}

const ReflectionTimer: React.FC = () => {
  const [secondsLeft, setSecondsLeft] = useState(TOTAL_SECONDS);
  const [isRunning, setIsRunning] = useState(false);
  const [promptIndex, setPromptIndex] = useState(0);
  const [isMusicOn, setIsMusicOn] = useState(true);

  const intervalRef = useRef<number | null>(null);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const startSong = async () => {
    try {
      if (audioRef.current) {
        // Some browsers require a user gesture before audio will play.
        await audioRef.current.play();
      }
    } catch (e) {
      console.warn("Unable to start audio (browser autoplay rules?)", e);
    }
  };

  const stopSong = () => {
    if (audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0; // rewind to beginning
    }
  };

  useEffect(() => {
    if (!isRunning) {
      if (intervalRef.current !== null) {
        window.clearInterval(intervalRef.current);
      }
      return;
    }

    intervalRef.current = window.setInterval(() => {
      setSecondsLeft((prev) => {
        if (prev <= 1) {
          window.clearInterval(intervalRef.current!);
          setIsRunning(false);
          stopSong();
          playChime();
          return 0;
        }

        const next = prev - 1;

        // Update reflection prompt approximately once per minute
        const elapsed = TOTAL_SECONDS - next;
        const newIndex = Math.min(
          reflectionPrompts.length - 1,
          Math.floor(elapsed / 60)
        );
        setPromptIndex(newIndex);

        return next;
      });
    }, 1000);

    return () => {
      if (intervalRef.current !== null) {
        window.clearInterval(intervalRef.current);
      }
    };
  }, [isRunning]);

  useEffect(() => {
    if (isRunning && isMusicOn) {
      startSong();
    } else {
      stopSong();
    }

    return () => {
      stopSong();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isRunning, isMusicOn]);

  const handleStartPause = () => {
    setIsRunning((prev) => !prev);
  };

  const handleReset = () => {
    setIsRunning(false);
    setSecondsLeft(TOTAL_SECONDS);
    setPromptIndex(0);
    stopSong();
  };

  const progress = 1 - secondsLeft / TOTAL_SECONDS; // 0 to 1
  const radius = 80;
  const circumference = 2 * Math.PI * radius;
  const dashOffset = circumference * (1 - progress);

  return (
    <div className="min-h-screen flex items-center justify-center relative overflow-hidden bg-slate-950 text-slate-50">
      {/* Soothing animated background */}
      <style>{`
        @keyframes slowFloat {
          0%, 100% { transform: translate3d(0, 0, 0) scale(1); opacity: 0.25; }
          50% { transform: translate3d(18px, -18px, 0) scale(1.06); opacity: 0.55; }
        }
        @keyframes subtleDrift {
          0%, 100% { transform: translate3d(0, 0, 0) rotate(0deg); }
          50% { transform: translate3d(-20px, 14px, 0) rotate(1.5deg); }
        }
        @keyframes shimmer {
          0%, 100% { opacity: 0.05; }
          50% { opacity: 0.16; }
        }
      `}</style>

      <div className="pointer-events-none absolute inset-0">
        <div
          className="absolute -top-48 -right-10 w-96 h-96 rounded-full bg-gradient-to-br from-sky-400/30 via-teal-300/20 to-emerald-300/30 blur-3xl"
          style={{ animation: "slowFloat 24s ease-in-out infinite" }}
        />
        <div
          className="absolute -bottom-52 -left-16 w-[30rem] h-[30rem] rounded-full bg-gradient-to-tr from-indigo-500/25 via-sky-400/20 to-cyan-300/30 blur-3xl"
          style={{ animation: "slowFloat 32s ease-in-out infinite" }}
        />
        <div
          className="absolute inset-8 rounded-[3rem] border border-slate-800/70 bg-slate-950/40 shadow-[0_0_60px_rgba(15,23,42,0.85)]"
          style={{ animation: "subtleDrift 36s ease-in-out infinite" }}
        />
        <div
          className="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(148,163,184,0.25),_transparent_60%),radial-gradient(circle_at_bottom,_rgba(56,189,248,0.12),_transparent_55%)]"
          style={{ animation: "shimmer 18s ease-in-out infinite" }}
        />
      </div>

      <div className="relative max-w-2xl w-full px-6 py-8 rounded-3xl bg-slate-900/80 backdrop-blur-2xl shadow-2xl border border-slate-700/70">
        <div className="flex flex-col md:flex-row items-center gap-8">
          {/* Timer Visual */}
          <div className="relative flex items-center justify-center">
            <div className="absolute inset-0 rounded-full bg-gradient-to-tr from-indigo-500/40 via-sky-400/20 to-emerald-400/40 blur-2xl opacity-70 animate-pulse" />

            <svg
              className="relative w-48 h-48 drop-shadow-lg"
              viewBox="0 0 200 200"
            >
              <defs>
                <linearGradient id="progressGradient" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stopColor="#38bdf8" />
                  <stop offset="50%" stopColor="#818cf8" />
                  <stop offset="100%" stopColor="#22c55e" />
                </linearGradient>
              </defs>

              <circle
                cx="100"
                cy="100"
                r={radius}
                stroke="#020617"
                strokeWidth="16"
                fill="#020617"
                opacity="0.9"
              />

              <circle
                cx="100"
                cy="100"
                r={radius}
                stroke="url(#progressGradient)"
                strokeWidth="14"
                fill="transparent"
                strokeDasharray={circumference}
                strokeDashoffset={dashOffset}
                strokeLinecap="round"
                style={{
                  transition: "stroke-dashoffset 0.6s ease-out",
                  transform: "rotate(-90deg)",
                  transformOrigin: "center",
                }}
              />

              <text
                x="100"
                y="96"
                textAnchor="middle"
                className="fill-slate-50 text-3xl font-semibold tracking-tight"
              >
                {formatTime(secondsLeft)}
              </text>
              <text
                x="100"
                y="124"
                textAnchor="middle"
                className="fill-slate-400 text-xs tracking-[0.25em] uppercase"
              >
                Reflect
              </text>
            </svg>
          </div>

          {/* Text + Controls */}
          <div className="flex-1 space-y-5">
            <div className="space-y-2">
              <p className="text-xs font-semibold tracking-[0.25em] uppercase text-sky-300/80">
                5-Minute Reflection
              </p>
              <h1 className="text-2xl md:text-3xl font-semibold text-slate-50 leading-snug">
                Pause. Breathe.
                <span className="text-sky-300"> Capture what matters.</span>
              </h1>
            </div>

            <div className="p-4 rounded-2xl bg-slate-800/70 border border-slate-700/80 shadow-inner">
              <p className="text-xs font-medium uppercase tracking-[0.2em] text-slate-400 mb-1">
                Reflection Prompt
              </p>
              <p className="text-sm md:text-base text-slate-50 leading-relaxed">
                {reflectionPrompts[promptIndex]}
              </p>
            </div>

            <div className="grid grid-cols-2 gap-3 max-w-xs">
              <button
                onClick={handleStartPause}
                className={`inline-flex items-center justify-center rounded-2xl px-4 py-2.5 text-sm font-semibold shadow-lg shadow-sky-500/20 border border-sky-400/60 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-400 focus:ring-offset-slate-900 ${
                  isRunning
                    ? "bg-slate-900/90 text-sky-300 hover:bg-slate-900"
                    : "bg-gradient-to-r from-sky-500 to-indigo-500 hover:from-sky-400 hover:to-indigo-400 text-slate-950"
                }`}
              >
                {isRunning ? "Pause" : secondsLeft === 0 ? "Restart" : "Start"}
              </button>

              <button
                onClick={handleReset}
                className="inline-flex items-center justify-center rounded-2xl px-4 py-2.5 text-sm font-medium border border-slate-600/80 bg-slate-900/80 text-slate-300 hover:bg-slate-800/90 hover:text-slate-50 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 focus:ring-offset-slate-900"
              >
                Reset
              </button>
            </div>

            <div className="flex items-center gap-2 text-[11px] text-slate-400">
              <button
                onClick={() => setIsMusicOn((prev) => !prev)}
                className="relative inline-flex items-center h-5 w-9 rounded-full border border-slate-600 bg-slate-950/80 focus:outline-none focus:ring-1 focus:ring-sky-400/70"
              >
                <span
                  className={`inline-block h-4 w-4 rounded-full bg-sky-400 shadow-sm transform transition-transform duration-200 ${
                    isMusicOn ? "translate-x-4" : "translate-x-0"
                  }`}
                />
              </button>
              <span className="font-medium">
                {isMusicOn ? "Focused Sound On" : "Focused Sound Off"}
              </span>
            </div>

            <p className="text-[11px] text-slate-400 leading-relaxed">
              Tip: Invite learners to jot down key ideas, questions, and next steps
              while the timer runs. When the chime sounds, have them share one
              takeaway with a partner or the group.
            </p>
          </div>
        </div>
      </div>

      {/* Hidden audio element that plays your calming music */}
      <audio ref={audioRef} src={SONG_URL} loop className="hidden" />
    </div>
  );
};

export default ReflectionTimer;
